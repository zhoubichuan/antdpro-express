name: prod
on:
  push:
    branches:
      - master
# è¦æ‰§è¡Œçš„ä»»åŠ¡
jobs:
  # runs-on æŒ‡å®šjobä»»åŠ¡è¿è¡Œæ‰€éœ€è¦çš„è™šæ‹ŸæœºçŽ¯å¢ƒï¼ˆå¿…å¡«ï¼‰
  # build:
  #   runs-on: ubuntu-latest

  #   # èŽ·å–æºç 
  #   steps:
  #     # ä½¿ç”¨actionåº“  actions/checkoutèŽ·å–æºç 
  #     - name: action
  #       uses: actions/checkout@v1

  #     - name: node v14.17.0
  #       uses: actions/setup-node@v1
  #       with:
  #         # é€‰æ‹©è¦ä½¿ç”¨çš„ node ç‰ˆæœ¬
  #         node-version: "v14.17.0"

      # - name: npm install â¬   // æ‰¾åˆ°vueé¡¹ç›®å®‰è£…ä¾èµ–å¼€å§‹æ‰“åŒ…
      #   run: |
      #     cd antdpro-express/vue3
      #     npm i
      #     npm run build

      # - name: å‰ç«¯vueæ–‡ä»¶æ‰“åŒ…ðŸ“¦
      #   run: |
      #     cd antdpro-express/vue3/dist 
      #     sudo apt-get install unzip // å…ˆåŽ‹ç¼©æ–‡ä»¶
      #     zip -r dist.zip ./* -r     // åŽ‹ç¼©distç›®å½•
      #     ls

      # # ä¸Šä¼ æ‰“åŒ…æ–‡ä»¶åˆ°è¿œç¨‹æœåŠ¡å™¨ è…¾è®¯
      # - name: Deployâ€”â€”TX ðŸš€
      #   uses: cross-the-world/ssh-scp-ssh-pipelines@latest # å› ä¸ºæž„å»ºä¹‹åŽï¼Œéœ€è¦æŠŠä»£ç ä¸Šä¼ åˆ°æœåŠ¡å™¨ä¸Šï¼Œæ‰€ä»¥éœ€è¦è¿žæŽ¥åˆ°sshï¼Œå¹¶ä¸”åšä¸€ä¸ªå®‰å…¨æ‹·è´(security copy)æ“ä½œ
      #   env:
      #     WELCOME: "ssh scp ssh pipelines"
      #     LASTSSH: "Doing something after copying"
      #   with:
      #     host: ${{ secrets.TX_HOST }}
      #     user: ${{ secrets.TX_USER }}
      #     pass: ${{ secrets.TX_PASS }}
      #     port: ${{ secrets.TX_PORT }}
      #     connect_timeout: 10s
      #     first_ssh: |
      #       rm -rf /usr/share/nginx/html
      #       mkdir -p /usr/share/nginx/html
      #     scp: |
      #       'node-koa-pm2/pmaoblog/dist/dist.zip' => /usr/share/nginx/html
      #     last_ssh: |
      #       cd /usr/share/nginx/html
      #       unzip dist.zip
      #       rm -rf dist.zip
            
  node:
    runs-on: ubuntu-latest

    # èŽ·å–æºç 
    steps:
      # ä½¿ç”¨actionåº“  actions/checkoutèŽ·å–æºç 
      - name: action
        uses: actions/checkout@v1

      - name: node v14.17.0
        uses: actions/setup-node@v1
        with:
          # é€‰æ‹©è¦ä½¿ç”¨çš„ node ç‰ˆæœ¬
          node-version: "v14.17.0"

      - name: zip ðŸ“¦
        run: |
          sudo apt-get install unzip
          zip -r antdpro-express.zip antdpro-express/

      # å¯åŠ¨nodeåŽå°æœåŠ¡
      - name: nodeéƒ¨ç½² ðŸš€ðŸš€
        uses: cross-the-world/ssh-scp-ssh-pipelines@latest # å› ä¸ºæž„å»ºä¹‹åŽï¼Œéœ€è¦æŠŠä»£ç ä¸Šä¼ åˆ°æœåŠ¡å™¨ä¸Šï¼Œæ‰€ä»¥éœ€è¦è¿žæŽ¥åˆ°sshï¼Œå¹¶ä¸”åšä¸€ä¸ªå®‰å…¨æ‹·è´(security copy)æ“ä½œ
        env:
          WELCOME: "ssh scp ssh pipelines"
          LASTSSH: "Doing something after copying"
        with:
          host: ${{ secrets.HOST }}
          user: ${{ secrets.USER }}
          pass: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          connect_timeout: 20s
          first_ssh: |
            rm -rf /usr/antdpro-express
            mkdir -p /usr/antdpro-express
          scp: |
            'antdpro-express.zip' => /usr/antdpro-express
          last_ssh: |
            cd /usr/antdpro-express
            unzip antdpro-express.zip
            cd /usr/antdpro-express
            npm i
#            pm2 start ./src/main.js
            pm2 restart ./app.js